openapi: 3.0.0
info:
  title: WasteWise API
  version: 1.0.0
  description: |-
    # WasteWise API Documentation

    WasteWise is a waste management optimization SaaS platform for multifamily properties.

    ## Features
    - **Async Job Processing**: Long-running analysis jobs with real-time progress tracking
    - **Invoice Extraction**: Claude Vision AI-powered data extraction from waste invoices
    - **Optimization Analysis**: Compactor utilization and cost optimization recommendations
    - **Regulatory Research**: Automated ordinance research and compliance checking
    - **Report Generation**: Excel workbooks and interactive HTML dashboards

    ## Authentication
    All API endpoints require authentication via Supabase JWT tokens.

    1. Obtain a token by calling `POST /api/auth/login`
    2. Include the token in all subsequent requests: `Authorization: Bearer <token>`
    3. Tokens expire after 1 hour - refresh using `POST /api/auth/refresh`

    ## Async Job Pattern
    Many operations are asynchronous due to AI processing times (30s - 5 minutes):

    1. **Start Job**: `POST /api/analyze` → Returns `{ jobId }`
    2. **Poll Status**: `GET /api/jobs/{jobId}` → Check `status` and `progress_percent`
    3. **Get Results**: When `status === "completed"`, access `result_data`

    ## Rate Limiting
    - **Authenticated users**: 100 requests/minute
    - **Admin users**: 500 requests/minute
    - Rate limit headers are returned: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`

    ## Error Handling
    All errors follow a consistent format:
    ```json
    {
      "error": "Human-readable error message",
      "code": "ERROR_CODE",
      "details": { /* Additional context */ }
    }
    ```

    ## Pagination
    List endpoints support pagination:
    - `page` (default: 1)
    - `limit` (default: 20, max: 100)
    - Response includes: `data`, `total`, `page`, `limit`, `totalPages`
  contact:
    name: WasteWise Support
    email: support@wastewise.com
  license:
    name: Proprietary
    url: https://wastewise.com/terms
servers:
  - url: https://wastewise.com
    description: Production server
tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Projects
    description: Project management operations
  - name: Files
    description: File upload and management
  - name: Analysis
    description: Waste analysis and optimization jobs
  - name: Jobs
    description: Job status and results
  - name: Reports
    description: Report generation and download
  - name: Admin
    description: Administrative operations (admin-only)
  - name: Health
    description: System health and monitoring
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token obtained from /api/auth/login
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
        details:
          type: object
          description: Additional error context
          additionalProperties: true
    ValidationError:
      type: object
      required:
        - error
        - code
        - details
      properties:
        error:
          type: string
          example: Validation failed
        code:
          type: string
          example: VALIDATION_ERROR
        details:
          type: object
          properties:
            issues:
              type: array
              items:
                type: object
                properties:
                  path:
                    type: array
                    items:
                      type: string
                  message:
                    type: string
    PaginatedResponse:
      type: object
      required:
        - data
        - total
        - page
        - limit
        - totalPages
      properties:
        data:
          type: array
          items: {}
        total:
          type: integer
          description: Total number of items
        page:
          type: integer
          description: Current page number
        limit:
          type: integer
          description: Items per page
        totalPages:
          type: integer
          description: Total number of pages
    User:
      type: object
      required:
        - id
        - email
        - role
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: User ID
        email:
          type: string
          format: email
          description: User email address
        role:
          type: string
          enum:
            - admin
            - user
          description: User role
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp
    Project:
      type: object
      required:
        - id
        - name
        - property_type
        - units
        - equipment_type
        - status
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        name:
          type: string
          example: Riverside Gardens Apartments
        property_type:
          type: string
          enum:
            - Garden-Style
            - Mid-Rise
            - High-Rise
          description: Property type
        units:
          type: integer
          minimum: 1
          example: 250
          description: Number of units in property
        equipment_type:
          type: string
          enum:
            - COMPACTOR
            - DUMPSTER
            - BOTH
          description: Waste equipment type
        location:
          type: object
          properties:
            city:
              type: string
            state:
              type: string
            zip:
              type: string
        status:
          type: string
          enum:
            - draft
            - processing
            - completed
            - failed
          description: Project status
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    AnalysisJob:
      type: object
      required:
        - id
        - status
        - job_type
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Job ID
        user_id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        job_type:
          type: string
          enum:
            - complete_analysis
            - invoice_extraction
            - contract_extraction
            - regulatory_research
          description: Type of analysis job
        status:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
          description: Current job status
        progress_percent:
          type: integer
          minimum: 0
          maximum: 100
          description: Completion percentage
        current_step:
          type: string
          description: Current processing step
          example: Extracting invoice data
        started_at:
          type: string
          format: date-time
          description: Processing start time
        completed_at:
          type: string
          format: date-time
          description: Processing completion time
        error_message:
          type: string
          description: Error message if job failed
        error_code:
          type: string
          description: Error code if job failed
        result_data:
          type: object
          description: Analysis results (available when status is completed)
          additionalProperties: true
        ai_usage:
          type: object
          description: AI token usage and cost tracking
          properties:
            input_tokens:
              type: integer
            output_tokens:
              type: integer
            total_cost:
              type: number
        created_at:
          type: string
          format: date-time
    ProjectFile:
      type: object
      required:
        - id
        - project_id
        - file_name
        - file_type
        - storage_path
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        file_name:
          type: string
          example: invoice-january-2025.pdf
        file_type:
          type: string
          enum:
            - invoice
            - contract
            - haul_log
          description: Type of document
        storage_path:
          type: string
          description: Supabase storage path
        file_size:
          type: integer
          description: File size in bytes
        mime_type:
          type: string
          example: application/pdf
        uploaded_at:
          type: string
          format: date-time
    SystemHealth:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
        timestamp:
          type: string
          format: date-time
        services:
          type: object
          properties:
            database:
              type: object
              properties:
                status:
                  type: string
                  enum:
                    - healthy
                    - degraded
                    - unhealthy
                latency_ms:
                  type: number
            storage:
              type: object
              properties:
                status:
                  type: string
                  enum:
                    - healthy
                    - degraded
                    - unhealthy
                latency_ms:
                  type: number
            ai:
              type: object
              properties:
                status:
                  type: string
                  enum:
                    - healthy
                    - degraded
                    - unhealthy
                latency_ms:
                  type: number
        version:
          type: string
          example: 1.0.0
  responses:
    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Authentication required
            code: UNAUTHORIZED
    ForbiddenError:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Insufficient permissions
            code: FORBIDDEN
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Resource not found
            code: NOT_FOUND
    ValidationError:
      description: Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
    RateLimitError:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Rate limit exceeded
            code: RATE_LIMIT_EXCEEDED
            details:
              limit: 100
              reset: '2025-01-15T12:00:00Z'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal server error
            code: INTERNAL_ERROR
  parameters:
    PageParam:
      name: page
      in: query
      description: Page number (1-indexed)
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    LimitParam:
      name: limit
      in: query
      description: Items per page
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    ProjectIdParam:
      name: id
      in: path
      description: Project ID
      required: true
      schema:
        type: string
        format: uuid
    JobIdParam:
      name: id
      in: path
      description: Job ID
      required: true
      schema:
        type: string
        format: uuid
security:
  - BearerAuth: []
paths:
  /api/analyze:
    post:
      summary: Create analysis job
      description: |
        Creates a background job for long-running waste analysis operations.

        **Async Job Pattern**:
        1. Create job with this endpoint → Returns `jobId`
        2. Poll `GET /api/jobs/{jobId}` every 2 seconds
        3. Check `status` field: `pending` → `processing` → `completed` or `failed`
        4. When completed, access results in `result_data` field

        **Processing Time**: 30 seconds to 5 minutes depending on job type and data volume
      tags:
        - Analysis
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - projectId
                - jobType
              properties:
                projectId:
                  type: string
                  format: uuid
                  description: Project ID to analyze
                  example: d82e2314-7ccf-404e-a133-0caebb154c7e
                jobType:
                  type: string
                  enum:
                    - invoice_extraction
                    - regulatory_research
                    - complete_analysis
                    - report_generation
                  description: Type of analysis to perform
                  example: complete_analysis
                inputData:
                  type: object
                  description: Optional job-specific input parameters
                  additionalProperties: true
                  example:
                    includeRegulatory: true
                priority:
                  type: integer
                  minimum: 1
                  maximum: 10
                  description: Job priority (1=highest, 10=lowest). Auto-assigned if not provided.
                  example: 5
            examples:
              complete_analysis:
                summary: Complete analysis with all features
                value:
                  projectId: d82e2314-7ccf-404e-a133-0caebb154c7e
                  jobType: complete_analysis
                  inputData:
                    includeRegulatory: true
                    generateReports: true
              invoice_extraction:
                summary: Invoice extraction only
                value:
                  projectId: d82e2314-7ccf-404e-a133-0caebb154c7e
                  jobType: invoice_extraction
                  priority: 3
      responses:
        '201':
          description: Job created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                    format: uuid
                    description: Job ID for polling status
                  status:
                    type: string
                    enum:
                      - pending
                    description: Initial job status
                  message:
                    type: string
                    description: Instructions for polling
              example:
                jobId: a1b2c3d4-e5f6-7890-abcd-ef1234567890
                status: pending
                message: Analysis job created. Poll /api/jobs/a1b2c3d4-e5f6-7890-abcd-ef1234567890 for status updates.
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Project not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Project not found or access denied
        '429':
          description: Rate limit exceeded (10 requests/minute)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until rate limit resets
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Maximum requests per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp when limit resets
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  retryAfter:
                    type: integer
              example:
                error: Rate limit exceeded. Please try again later.
                retryAfter: 45
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/health:
    get:
      summary: API health check
      description: Check if the API is responding. Does not require authentication.
      tags:
        - Health
      security: []
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: 1.0.0
  /api/health/worker:
    get:
      summary: Worker health check
      description: Check if background workers are running and processing jobs
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Worker health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - healthy
                      - degraded
                      - unhealthy
                  workersRunning:
                    type: integer
                    description: Number of active workers
                  pendingJobs:
                    type: integer
                    description: Number of pending jobs in queue
                  processingJobs:
                    type: integer
                    description: Number of jobs currently processing
                  lastJobProcessed:
                    type: string
                    format: date-time
                    description: Timestamp of last processed job
  /api/jobs/{id}:
    get:
      summary: Get job status
      description: |
        Poll this endpoint to check the status of an analysis job.

        **Polling Pattern**:
        - Poll every 2 seconds while `status === "pending"` or `status === "processing"`
        - Stop polling when `status === "completed"` or `status === "failed"`
        - Use `progress_percent` and `current_step` to show progress to users
      tags:
        - Jobs
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobIdParam'
      responses:
        '200':
          description: Job status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisJob'
              examples:
                pending:
                  summary: Job pending in queue
                  value:
                    id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
                    user_id: u123
                    project_id: d82e2314-7ccf-404e-a133-0caebb154c7e
                    job_type: complete_analysis
                    status: pending
                    progress_percent: 0
                    current_step: Waiting in queue
                    created_at: '2025-01-15T10:00:00Z'
                processing:
                  summary: Job in progress
                  value:
                    id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
                    user_id: u123
                    project_id: d82e2314-7ccf-404e-a133-0caebb154c7e
                    job_type: complete_analysis
                    status: processing
                    progress_percent: 45
                    current_step: Extracting invoice data (3/6 files)
                    started_at: '2025-01-15T10:01:00Z'
                    created_at: '2025-01-15T10:00:00Z'
                completed:
                  summary: Job completed successfully
                  value:
                    id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
                    user_id: u123
                    project_id: d82e2314-7ccf-404e-a133-0caebb154c7e
                    job_type: complete_analysis
                    status: completed
                    progress_percent: 100
                    current_step: Completed
                    started_at: '2025-01-15T10:01:00Z'
                    completed_at: '2025-01-15T10:04:30Z'
                    result_data:
                      yardsPerDoor: 0.12
                      costPerDoor: 18.5
                      optimizations:
                        - type: compactor_monitors
                          savings: 1200
                    ai_usage:
                      input_tokens: 15000
                      output_tokens: 3000
                      total_cost: 0.45
                    created_at: '2025-01-15T10:00:00Z'
                failed:
                  summary: Job failed with error
                  value:
                    id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
                    user_id: u123
                    project_id: d82e2314-7ccf-404e-a133-0caebb154c7e
                    job_type: complete_analysis
                    status: failed
                    progress_percent: 30
                    current_step: Failed during invoice extraction
                    error_message: 'Invalid invoice format: missing required fields'
                    error_code: EXTRACTION_ERROR
                    started_at: '2025-01-15T10:01:00Z'
                    completed_at: '2025-01-15T10:02:00Z'
                    created_at: '2025-01-15T10:00:00Z'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/jobs:
    get:
      summary: List user's jobs
      description: Get paginated list of analysis jobs for the authenticated user
      tags:
        - Jobs
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          description: Filter by job status
          schema:
            type: string
            enum:
              - pending
              - processing
              - completed
              - failed
        - name: jobType
          in: query
          description: Filter by job type
          schema:
            type: string
            enum:
              - invoice_extraction
              - regulatory_research
              - complete_analysis
              - report_generation
      responses:
        '200':
          description: Jobs list retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/AnalysisJob'
              example:
                data:
                  - id: job1
                    status: completed
                    job_type: complete_analysis
                    created_at: '2025-01-15T10:00:00Z'
                  - id: job2
                    status: processing
                    job_type: invoice_extraction
                    created_at: '2025-01-15T11:00:00Z'
                total: 15
                page: 1
                limit: 20
                totalPages: 1
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /api/projects/{id}/analyze:
    post:
      summary: Analyze specific project
      description: Shortcut endpoint to create complete_analysis job for a project
      tags:
        - Projects
        - Analysis
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ProjectIdParam'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                includeRegulatory:
                  type: boolean
                  description: Include regulatory compliance research
                  default: true
                generateReports:
                  type: boolean
                  description: Generate Excel and HTML reports
                  default: true
      responses:
        '201':
          description: Analysis job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: pending
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/admin/jobs:
    get:
      summary: List all jobs (admin)
      description: Get paginated list of all analysis jobs across all users. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          schema:
            type: string
            enum:
              - pending
              - processing
              - completed
              - failed
        - name: userId
          in: query
          description: Filter by user ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Jobs list retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/AnalysisJob'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/jobs/{id}:
    get:
      summary: Get job details (admin)
      description: Get detailed information about any job. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobIdParam'
      responses:
        '200':
          description: Job details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisJob'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/admin/jobs/{id}/retry:
    post:
      summary: Retry failed job (admin)
      description: Create a new job with the same parameters as a failed job. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobIdParam'
      responses:
        '201':
          description: Retry job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                    format: uuid
                  originalJobId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: pending
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/admin/jobs/monitoring:
    get:
      summary: Get job queue metrics (admin)
      description: Real-time metrics about job queue health and performance. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Queue metrics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  queue:
                    type: object
                    properties:
                      pending:
                        type: integer
                        description: Jobs waiting to be processed
                      processing:
                        type: integer
                        description: Jobs currently being processed
                      completed_last_hour:
                        type: integer
                      failed_last_hour:
                        type: integer
                      avg_processing_time_seconds:
                        type: number
                        description: Average processing time
                  workers:
                    type: object
                    properties:
                      active:
                        type: integer
                        description: Number of active workers
                      idle:
                        type: integer
                        description: Number of idle workers
                  performance:
                    type: object
                    properties:
                      jobs_per_minute:
                        type: number
                        description: Current throughput
                      avg_wait_time_seconds:
                        type: number
                        description: Average time jobs spend waiting
              example:
                queue:
                  pending: 5
                  processing: 2
                  completed_last_hour: 45
                  failed_last_hour: 1
                  avg_processing_time_seconds: 135.5
                workers:
                  active: 2
                  idle: 1
                performance:
                  jobs_per_minute: 0.5
                  avg_wait_time_seconds: 15.3
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/jobs/stats:
    get:
      summary: Get job statistics (admin)
      description: Historical statistics and trends for job processing. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - name: period
          in: query
          description: Time period for statistics
          schema:
            type: string
            enum:
              - hour
              - day
              - week
              - month
            default: day
      responses:
        '200':
          description: Job statistics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                  total_jobs:
                    type: integer
                  completed:
                    type: integer
                  failed:
                    type: integer
                  success_rate:
                    type: number
                    description: Percentage of successful jobs
                  by_type:
                    type: object
                    additionalProperties:
                      type: object
                      properties:
                        count:
                          type: integer
                        avg_duration_seconds:
                          type: number
                  by_hour:
                    type: array
                    items:
                      type: object
                      properties:
                        hour:
                          type: integer
                        count:
                          type: integer
              example:
                period: day
                total_jobs: 120
                completed: 115
                failed: 5
                success_rate: 95.83
                by_type:
                  complete_analysis:
                    count: 80
                    avg_duration_seconds: 145.2
                  invoice_extraction:
                    count: 40
                    avg_duration_seconds: 45.8
                by_hour:
                  - hour: 0
                    count: 5
                  - hour: 1
                    count: 3
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/workers/health:
    get:
      summary: Get worker health status (admin)
      description: Detailed health information for all background workers. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Worker health retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum:
                      - healthy
                      - degraded
                      - unhealthy
                  workers:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        status:
                          type: string
                          enum:
                            - active
                            - idle
                            - stuck
                            - crashed
                        current_job_id:
                          type: string
                          format: uuid
                        uptime_seconds:
                          type: integer
                        jobs_processed:
                          type: integer
                        last_heartbeat:
                          type: string
                          format: date-time
              example:
                status: healthy
                workers:
                  - id: worker-1
                    status: active
                    current_job_id: job123
                    uptime_seconds: 3600
                    jobs_processed: 25
                    last_heartbeat: '2025-01-15T10:00:00Z'
                  - id: worker-2
                    status: idle
                    current_job_id: null
                    uptime_seconds: 3600
                    jobs_processed: 30
                    last_heartbeat: '2025-01-15T10:00:00Z'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/system/health:
    get:
      summary: Get system health (admin)
      description: Overall system health including all services. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: System health retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemHealth'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/system/metrics:
    get:
      summary: Get system metrics (admin)
      description: Performance and usage metrics for the system. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: System metrics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
                  api:
                    type: object
                    properties:
                      requests_per_minute:
                        type: number
                      avg_response_time_ms:
                        type: number
                      error_rate:
                        type: number
                        description: Percentage of requests that errored
                  database:
                    type: object
                    properties:
                      connections_active:
                        type: integer
                      avg_query_time_ms:
                        type: number
                      slow_queries:
                        type: integer
                        description: Queries taking >1s in last minute
                  storage:
                    type: object
                    properties:
                      total_files:
                        type: integer
                      total_size_mb:
                        type: number
                      uploads_last_hour:
                        type: integer
                  ai:
                    type: object
                    properties:
                      requests_last_hour:
                        type: integer
                      total_tokens_last_hour:
                        type: integer
                      total_cost_last_hour:
                        type: number
              example:
                timestamp: '2025-01-15T10:00:00Z'
                api:
                  requests_per_minute: 45.2
                  avg_response_time_ms: 125.5
                  error_rate: 0.5
                database:
                  connections_active: 12
                  avg_query_time_ms: 15.3
                  slow_queries: 2
                storage:
                  total_files: 1250
                  total_size_mb: 5420.5
                  uploads_last_hour: 35
                ai:
                  requests_last_hour: 120
                  total_tokens_last_hour: 250000
                  total_cost_last_hour: 7.5
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/users:
    get:
      summary: List all users (admin)
      description: Get paginated list of all users. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: search
          in: query
          description: Search by email or name
          schema:
            type: string
        - name: role
          in: query
          description: Filter by role
          schema:
            type: string
            enum:
              - admin
              - user
      responses:
        '200':
          description: Users list retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/users/{id}:
    get:
      summary: Get user details (admin)
      description: Get detailed information about a specific user. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User details retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/User'
                  - type: object
                    properties:
                      projects_count:
                        type: integer
                      jobs_count:
                        type: integer
                      total_ai_cost:
                        type: number
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    patch:
      summary: Update user (admin)
      description: Update user role or status. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                  enum:
                    - admin
                    - user
                is_active:
                  type: boolean
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/admin/skills:
    get:
      summary: List all skills (admin)
      description: Get configuration for all available skills. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Skills list retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  skills:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        skill_name:
                          type: string
                        skill_version:
                          type: string
                        enabled:
                          type: boolean
                        conversion_rates:
                          type: object
                        thresholds:
                          type: object
              example:
                skills:
                  - id: skill1
                    skill_name: compactor-optimization
                    skill_version: 1.0.0
                    enabled: true
                    conversion_rates:
                      compactorYPD: 14.49
                      dumpsterYPD: 4.33
                    thresholds:
                      optimizationThreshold: 6
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/admin/skills/{id}:
    patch:
      summary: Update skill configuration (admin)
      description: Update conversion rates or thresholds for a skill. Admin only. USE WITH CAUTION.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                conversion_rates:
                  type: object
                  description: Updated conversion rates
                thresholds:
                  type: object
                  description: Updated thresholds
                enabled:
                  type: boolean
                  description: Enable/disable skill
      responses:
        '200':
          description: Skill updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  skill_name:
                    type: string
                  skill_version:
                    type: string
                  enabled:
                    type: boolean
                  conversion_rates:
                    type: object
                  thresholds:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/admin/audit:
    get:
      summary: Get audit log (admin)
      description: Retrieve audit log of admin actions. Admin only.
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: action
          in: query
          description: Filter by action type
          schema:
            type: string
        - name: userId
          in: query
          description: Filter by user who performed action
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Audit log retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            user_id:
                              type: string
                              format: uuid
                            action:
                              type: string
                            resource_type:
                              type: string
                            resource_id:
                              type: string
                            changes:
                              type: object
                            timestamp:
                              type: string
                              format: date-time
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
