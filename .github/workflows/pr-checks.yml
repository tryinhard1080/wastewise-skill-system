name: PR Quality Checks

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

jobs:
  # Job 1: Install dependencies (cached for reuse)
  setup:
    name: Setup & Cache Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

  # Job 2: TypeScript Type Checking
  type-check:
    name: TypeScript Compilation
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript compiler
        run: pnpm tsc --noEmit

      - name: Comment on PR (if failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **TypeScript compilation failed**\n\nPlease fix type errors before merging. Run `pnpm tsc --noEmit` locally to see details.'
            })

  # Job 3: ESLint
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Comment on PR (if failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Linting failed**\n\nPlease fix linting errors before merging. Run `pnpm lint` locally to see details.'
            })

  # Job 4: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit
        env:
          NODE_ENV: test

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7

      - name: Comment on PR (if failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Unit tests failed**\n\nPlease fix failing tests before merging. Run `pnpm test:unit` locally to see details.'
            })

  # Job 5: Integration Tests (with secrets)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: setup
    # Only run integration tests if secrets are available
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests
        run: pnpm test:integration
        env:
          NODE_ENV: test
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Comment on PR (if failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Integration tests failed**\n\nPlease check integration test failures. These tests use real API connections.'
            })

  # Job 6: Formula Validation (Critical for WasteWise)
  formula-validation:
    name: Formula & Calculation Validation
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for hardcoded formulas
        run: |
          echo "üîç Checking for hardcoded formula values..."

          # Check for hardcoded conversion rates
          HARDCODED_14_49=$(git diff origin/master...HEAD | grep -E '^\+.*14\.49' | grep -v 'lib/constants/formulas.ts' | grep -v '.github' || true)
          HARDCODED_4_33=$(git diff origin/master...HEAD | grep -E '^\+.*4\.33' | grep -v 'lib/constants/formulas.ts' | grep -v '.github' || true)
          HARDCODED_8_5=$(git diff origin/master...HEAD | grep -E '^\+.*8\.5' | grep -v 'lib/constants/formulas.ts' | grep -v '.github' || true)
          HARDCODED_6_0=$(git diff origin/master...HEAD | grep -E '^\+.*[^0-9]6\.0[^0-9]' | grep -v 'lib/constants/formulas.ts' | grep -v '.github' || true)

          ERRORS=""

          if [ ! -z "$HARDCODED_14_49" ]; then
            ERRORS="${ERRORS}\n‚ùå Found hardcoded 14.49 (compactor YPD conversion)"
            echo "$HARDCODED_14_49"
          fi

          if [ ! -z "$HARDCODED_4_33" ]; then
            ERRORS="${ERRORS}\n‚ùå Found hardcoded 4.33 (dumpster YPD conversion)"
            echo "$HARDCODED_4_33"
          fi

          if [ ! -z "$HARDCODED_8_5" ]; then
            ERRORS="${ERRORS}\n‚ùå Found hardcoded 8.5 (target compactor capacity)"
            echo "$HARDCODED_8_5"
          fi

          if [ ! -z "$HARDCODED_6_0" ]; then
            ERRORS="${ERRORS}\n‚ùå Found hardcoded 6.0 (optimization threshold)"
            echo "$HARDCODED_6_0"
          fi

          if [ ! -z "$ERRORS" ]; then
            echo -e "$ERRORS"
            echo ""
            echo "‚ö†Ô∏è  CRITICAL: Hardcoded formula values detected!"
            echo "üìù All formula values must be imported from lib/constants/formulas.ts"
            echo ""
            echo "Example:"
            echo "  import { COMPACTOR_YPD_CONVERSION } from '@/lib/constants/formulas'"
            echo "  const ypd = tons * COMPACTOR_YPD_CONVERSION"
            exit 1
          fi

          echo "‚úÖ No hardcoded formula values detected"

      - name: Run calculation tests
        run: pnpm test __tests__/calculations/
        if: always()
        env:
          NODE_ENV: test

      - name: Run formula validation evals
        run: pnpm eval
        if: always()
        continue-on-error: true
        id: evals

      - name: Check eval results
        if: steps.evals.outcome == 'failure'
        run: |
          echo "::error::Formula validation evals failed! Calculations do not match reference implementation."
          exit 1

      - name: Comment on PR (if evals failed)
        if: steps.evals.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Formula Validation Evals Failed**\n\n' +
                    'Calculations do not match reference implementation within <0.01% tolerance.\n\n' +
                    '**Required Actions:**\n' +
                    '1. Review eval execution logs for specific failures\n' +
                    '2. Ensure all formulas use constants from `lib/constants/formulas.ts`\n' +
                    '3. Verify calculations match `WASTE_FORMULAS_REFERENCE.md` v2.0\n' +
                    '4. Run `pnpm eval` locally to validate fixes\n\n' +
                    'See `docs/FORMULA_VALIDATION.md` for guidance.'
            })

      - name: Comment on PR (if hardcoded values found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Formula validation failed**\n\n' +
                    'Hardcoded formula values detected! All calculation constants must be imported from `lib/constants/formulas.ts`.\n\n' +
                    '**Critical WasteWise constants:**\n' +
                    '- `14.49` ‚Üí `COMPACTOR_YPD_CONVERSION`\n' +
                    '- `4.33` ‚Üí `DUMPSTER_YPD_CONVERSION`\n' +
                    '- `8.5` ‚Üí `COMPACTOR_TARGET_CAPACITY`\n' +
                    '- `6.0` ‚Üí `COMPACTOR_OPTIMIZATION_THRESHOLD`\n\n' +
                    'See `WASTE_FORMULAS_REFERENCE.md` for details.'
            })

  # Job 7: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --prod
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          echo "üîç Checking for potential secrets in code..."

          # Check for potential API keys or secrets
          SECRETS=$(git diff origin/master...HEAD | grep -E '^\+.*(api_key|apikey|secret|password|token).*=.*["\x27][A-Za-z0-9]{20,}["\x27]' || true)

          if [ ! -z "$SECRETS" ]; then
            echo "‚ö†Ô∏è  WARNING: Potential secrets detected in code!"
            echo "$SECRETS"
            echo ""
            echo "Please ensure these are environment variables, not hardcoded secrets."
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets detected"

  # Job 8: Build Test
  build:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [type-check, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          # Use dummy values for build-time environment variables
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          NEXT_PUBLIC_APP_URL: https://placeholder.com

      - name: Comment on PR (if build fails)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Build failed**\n\nThe Next.js build is failing. Run `pnpm build` locally to debug.'
            })

  # Job 9: All Checks Summary
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [type-check, lint, unit-tests, formula-validation, security, build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.formula-validation.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Some required checks failed"
            exit 1
          fi
          echo "‚úÖ All required checks passed!"

      - name: Comment success on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **All quality checks passed!**\n\n' +
                    '- TypeScript compilation ‚úì\n' +
                    '- Linting ‚úì\n' +
                    '- Unit tests ‚úì\n' +
                    '- Formula validation ‚úì\n' +
                    '- Security scan ‚úì\n' +
                    '- Build test ‚úì\n\n' +
                    'This PR is ready for review and merge.'
            })
